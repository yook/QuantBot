<template>
  <div>
    <div class="demo-collapse mb-4">
      <el-collapse accordion>
        <el-collapse-item name="1">
          <template #title="{ isActive }">
            <div :class="['title-wrapper', { 'is-active': isActive }]">
              –ê–ª–≥–æ—Ä–∏—Ç–º—ã –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
              <el-icon class="header-icon">
                <InfoFilled />
              </el-icon>
            </div>
          </template>
          <div class="text-sm">
            <div class="mb-4">
              <h3 class="font-bold mb-2">
                üîó –°–≤—è–∑–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (Connected Components)
              </h3>
              <strong>–ü—Ä–∏–Ω—Ü–∏–ø:</strong> –°—Ç—Ä–æ–∏—Ç—Å—è –≥—Ä–∞—Ñ —Å—Ö–æ–¥—Å—Ç–≤–∞, –≥–¥–µ —Ñ—Ä–∞–∑—ã ‚Äî
              –≤–µ—Ä—à–∏–Ω—ã, –∞ —Ä—ë–±—Ä–∞ —Å–æ–µ–¥–∏–Ω—è—é—Ç –ø–∞—Ä—ã —Å –∫–æ—Å–∏–Ω—É—Å–Ω—ã–º —Å—Ö–æ–¥—Å—Ç–≤–æ–º ‚â•
              threshold. –ö–ª–∞—Å—Ç–µ—Ä—ã = —Å–≤—è–∑–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≥—Ä–∞—Ñ–∞.<br /><br />

              <strong>–ê–ª–≥–æ—Ä–∏—Ç–º:</strong><br />
              ‚Ä¢ –ü–æ–ª—É—á–∏—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ OpenAI Embeddings<br />
              ‚Ä¢ –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ: —Ä–µ–±—Ä–æ –º–µ–∂–¥—É —Ñ—Ä–∞–∑–∞–º–∏, –µ—Å–ª–∏ —Å—Ö–æ–¥—Å—Ç–≤–æ ‚â•
              threshold<br />
              ‚Ä¢ –ù–∞–π—Ç–∏ —Å–≤—è–∑–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (DFS/BFS), –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã ‚â• 2 —Ñ—Ä–∞–∑ ‚Üí
              –∫–ª–∞—Å—Ç–µ—Ä—ã<br />
              ‚Ä¢ –ü—Ä–∏—Å–≤–æ–∏—Ç—å –º–µ—Ç–∫–∏ <code>cluster-1</code>, <code>cluster-2</code>,
              ...<br /><br />

              <strong>–ü–ª—é—Å—ã:</strong> –ü—Ä–æ—Å—Ç–æ–π (1 –ø–∞—Ä–∞–º–µ—Ç—Ä), –±—ã—Å—Ç—Ä—ã–π, —Ö–æ—Ä–æ—à –¥–ª—è
              —á—ë—Ç–∫–∏—Ö –≥—Ä—É–ø–ø.<br />
              <strong>–ú–∏–Ω—É—Å—ã:</strong> –†–∏—Å–∫ "—ç—Ñ—Ñ–µ–∫—Ç–∞ —Ü–µ–ø–æ—á–∫–∏" ‚Äî –ø—Ä–∏ –Ω–∏–∑–∫–æ–º
              threshold –≤—Å—ë –º–æ–∂–µ—Ç —Å–ª–∏—Ç—å—Å—è –≤ –æ–¥–∏–Ω –∫–ª–∞—Å—Ç–µ—Ä —á–µ—Ä–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ
              —Ñ—Ä–∞–∑—ã.
            </div>

            <div class="mb-2">
              <h3 class="font-bold mb-2">
                üéØ DBSCAN (Density-Based Spatial Clustering)
              </h3>
              <strong>–ü—Ä–∏–Ω—Ü–∏–ø:</strong> –ü–ª–æ—Ç–Ω–æ—Å—Ç–Ω–∞—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è. –¢–æ—á–∫–∞
              —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —è–¥—Ä–æ–º –∫–ª–∞—Å—Ç–µ—Ä–∞, –µ—Å–ª–∏ –≤ —Ä–∞–¥–∏—É—Å–µ eps —É –Ω–µ—ë ‚â• minPts
              —Å–æ—Å–µ–¥–µ–π. –ö–ª–∞—Å—Ç–µ—Ä—ã —Ä–∞—Å—Ç—É—Ç –æ—Ç —è–¥–µ—Ä, –Ω–µ —Å–ª–∏–≤–∞—è –≤—Å—ë –ø–æ–¥—Ä—è–¥.<br /><br />

              <strong>–ê–ª–≥–æ—Ä–∏—Ç–º:</strong><br />
              ‚Ä¢ –î–ª—è –∫–∞–∂–¥–æ–π —Ñ—Ä–∞–∑—ã –Ω–∞–π—Ç–∏ —Å–æ—Å–µ–¥–µ–π –≤ —Ä–∞–¥–∏—É—Å–µ eps (–∫–æ—Å–∏–Ω—É—Å–Ω–æ–µ
              —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ = 1 - —Å—Ö–æ–¥—Å—Ç–≤–æ)<br />
              ‚Ä¢ –ï—Å–ª–∏ —Å–æ—Å–µ–¥–µ–π ‚â• minPts ‚Üí —Ñ—Ä–∞–∑–∞ = —è–¥—Ä–æ –∫–ª–∞—Å—Ç–µ—Ä–∞<br />
              ‚Ä¢ –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ—Å–µ–¥–µ–π —è–¥–µ—Ä –≤ –∫–ª–∞—Å—Ç–µ—Ä<br />
              ‚Ä¢ –§—Ä–∞–∑—ã –±–µ–∑ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ (–≤—ã–±—Ä–æ—Å—ã) –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è –∏
              –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –º–µ—Ç–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞<br /><br />

              <strong>–ü–ª—é—Å—ã:</strong> –ó–∞—â–∏—Ç–∞ –æ—Ç —Ü–µ–ø–æ—á–∫–∏, —É—á—ë—Ç –ª–æ–∫–∞–ª—å–Ω–æ–π
              –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ–¥–∏–Ω–æ—á–Ω—ã—Ö —Ñ—Ä–∞–∑.<br />
              <strong>–ú–∏–Ω—É—Å—ã:</strong> –°–ª–æ–∂–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å (2 –ø–∞—Ä–∞–º–µ—Ç—Ä–∞: eps –∏
              minPts), –≤—ã–±—Ä–æ—Å—ã –Ω–µ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑—É—é—Ç—Å—è.
            </div>

            <div class="text-xs text-gray-400 mt-2">
              üí° <strong>–°–æ–≤–µ—Ç:</strong> –î–ª—è —Å—Ç—Ä–æ–≥–∏—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –Ω–∞—á–Ω–∏—Ç–µ —Å–æ
              <strong>–°–≤—è–∑–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç (threshold=0.8)</strong>. –ï—Å–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç–µ
              –≥–∏–≥–∞–Ω—Ç—Å–∫–∏–µ –∫–ª–∞—Å—Ç–µ—Ä—ã ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ
              <strong>DBSCAN (eps=0.2, minPts=2)</strong>.
            </div>

            <div class="text-xs text-amber-600 mt-3 p-2 bg-amber-50 rounded">
              ‚ö†Ô∏è <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫
              <strong>—Ü–µ–ª–µ–≤—ã–º –∑–∞–ø—Ä–æ—Å–∞–º</strong> (target_query = 1). –û—Å—Ç–∞–ª—å–Ω—ã–µ
              —Ñ—Ä–∞–∑—ã –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –º–µ—Ç–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞.
            </div>
          </div>
        </el-collapse-item>
      </el-collapse>
      <!-- Settings moved below the collapse -->
      <div class="mt-4">
        <el-form :model="form" label-position="left" label-width="250px">
          <el-form-item label="–ê–ª–≥–æ—Ä–∏—Ç–º –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏">
            <el-select v-model="form.algorithm" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∞–ª–≥–æ—Ä–∏—Ç–º">
              <el-option label="–°–≤—è–∑–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã" value="components" />
              <el-option
                label="DBSCAN (–ø–ª–æ—Ç–Ω–æ—Å—Ç–Ω–∞—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è)"
                value="dbscan"
              />
            </el-select>
            <div class="text-xs text-gray-500 mt-1">
              <strong>–°–≤—è–∑–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:</strong> –ø—Ä–æ—Å—Ç–æ–π –∏ –±—ã—Å—Ç—Ä—ã–π, –Ω–æ –º–æ–∂–µ—Ç
              —Å–ª–∏—Ç—å –≤—Å—ë –≤ –æ–¥–∏–Ω –∫–ª–∞—Å—Ç–µ—Ä –ø—Ä–∏ –Ω–∏–∑–∫–æ–º –ø–æ—Ä–æ–≥–µ.<br />
              <strong>DBSCAN:</strong> —É—á–∏—Ç—ã–≤–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—É—é –ø–ª–æ—Ç–Ω–æ—Å—Ç—å, –∑–∞—â–∏—â–∞–µ—Ç
              –æ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∞ —Ü–µ–ø–æ—á–∫–∏, –Ω–æ —Å–ª–æ–∂–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å.
            </div>
          </el-form-item>

          <el-form-item
            v-if="form.algorithm === 'components'"
            label="–ü–æ—Ä–æ–≥ —Å—Ö–æ–¥—Å—Ç–≤–∞ (threshold)"
          >
            <el-slider
              class="class-slider"
              v-model="value"
              :step="0.01"
              :min="0"
              :max="1"
              show-input
            />
            <div class="text-xs text-gray-500 mt-1">
              –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Ñ—Ä–∞–∑–∞–º–∏.
              –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 0.7‚Äì0.85 –¥–ª—è —Å—Ç—Ä–æ–≥–∏—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤.
            </div>
          </el-form-item>

          <el-form-item
            v-if="form.algorithm === 'dbscan'"
            label="–†–∞–¥–∏—É—Å –æ–∫—Ä–µ—Å—Ç–Ω–æ—Å—Ç–∏ (eps)"
          >
            <el-slider
              class="class-slider"
              v-model="dbscanEps"
              :step="0.01"
              :min="0.05"
              :max="0.95"
              show-input
            />
            <div class="text-xs text-gray-500 mt-1">
              –ö–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ = 1 - —Å—Ö–æ–¥—Å—Ç–≤–æ. –î–ª—è —Å—Ö–æ–¥—Å—Ç–≤–∞ 0.7 ‚Üí eps=0.3.
              –ú–µ–Ω—å—à–µ eps ‚Üí —Å—Ç—Ä–æ–∂–µ –∫–ª–∞—Å—Ç–µ—Ä—ã.
            </div>
          </el-form-item>

          <el-form-item
            v-if="form.algorithm === 'dbscan'"
            label="–ú–∏–Ω–∏–º—É–º —Ç–æ—á–µ–∫ (minPts)"
          >
            <el-input-number
              v-model="dbscanMinPts"
              :min="1"
              :max="10"
              :step="1"
            />
            <div class="text-xs text-gray-500 mt-1">
              –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Å–µ–¥–µ–π –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–ª–æ—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏.
              –û–±—ã—á–Ω–æ 2‚Äì5.
            </div>
          </el-form-item>
        </el-form>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref } from "vue";
import { watch } from "vue";
import { ipcClient } from "../../../stores/socket-client";
import { useProjectStore } from "../../../stores/project";
import { InfoFilled } from "@element-plus/icons-vue";
import {
  ElForm,
  ElFormItem,
  ElInputNumber,
  ElSlider,
  ElSelect,
  ElOption,
  ElButton,
  ElCollapse,
  ElCollapseItem,
  ElIcon,
} from "element-plus";

const project = useProjectStore();

const form = ref({
  eps: 0.5,
  algorithm: "components", // 'components' or 'dbscan'
});

// Local slider value bound to UI
const value = ref(form.value.eps);

// DBSCAN-specific parameters
const dbscanEps = ref(0.3); // –∫–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ (1 - similarity)
const dbscanMinPts = ref(2);

// Keep form.eps in sync with slider value
watch(
  () => value.value,
  (v) => {
    form.value.eps = Number(v);
  }
);

// Persist settings changes
watch(
  () => [
    form.value.algorithm,
    form.value.eps,
    dbscanEps.value,
    dbscanMinPts.value,
  ],
  () => {
    persistToProject();
  },
  { deep: true }
);

const diagnostics = ref({
  sample: 0,
  medianNNsim: 0,
  p75: 0,
  suggestedThreshold: 0,
  hist: [],
});

// listen for clustering diagnostics emitted by server when worker runs
socket.on("keywords:clustering-diagnostics", (payload) => {
  try {
    if (!payload || !payload.projectId) return;
    const d = payload.diagnostics || payload;
    diagnostics.value = {
      sample: d.sample || 0,
      medianNNsim: d.medianNNsim || 0,
      p75: d.p75 || 0,
      suggestedThreshold: d.suggestedThreshold || 0,
      hist: Array.isArray(d.hist) ? d.hist : [],
    };
  } catch (e) {}
});

// debounce timer for saving settings
let saveTimer = null;

function persistToProject() {
  const projectId =
    project.currentProjectId || (project.data && project.data.id);
  if (!projectId) return;
  try {
    if (!project.data) project.data = {};
    project.data.clustering_eps = Number(form.value.eps);
    project.data.clustering_algorithm = form.value.algorithm;
    project.data.clustering_dbscan_eps = Number(dbscanEps.value);
    project.data.clustering_dbscan_minPts = Number(dbscanMinPts.value);
    project.updateProject();
  } catch (e) {
    console.warn("Failed to persist clustering params to project", e);
  }
}

// Initialize form from current project settings if available
if (project && project.data) {
  try {
    const eps = project.data.clustering_eps;
    const algorithm = project.data.clustering_algorithm;
    const dbscan_eps = project.data.clustering_dbscan_eps;
    const dbscan_minPts = project.data.clustering_dbscan_minPts;

    if (typeof eps !== "undefined" && eps !== null) {
      form.value.eps = Number(eps);
      value.value = Number(eps); // Sync slider
    }
    if (typeof algorithm !== "undefined" && algorithm !== null)
      form.value.algorithm = String(algorithm);
    if (typeof dbscan_eps !== "undefined" && dbscan_eps !== null)
      dbscanEps.value = Number(dbscan_eps);
    if (typeof dbscan_minPts !== "undefined" && dbscan_minPts !== null)
      dbscanMinPts.value = Number(dbscan_minPts);
  } catch (e) {
    // ignore
  }
}

// Update form when current project changes
watch(
  () => project.currentProjectId,
  (newId) => {
    if (!newId) return;
    try {
      const eps = project.data && project.data.clustering_eps;
      const algorithm = project.data && project.data.clustering_algorithm;
      const dbscan_eps = project.data && project.data.clustering_dbscan_eps;
      const dbscan_minPts =
        project.data && project.data.clustering_dbscan_minPts;

      if (typeof eps !== "undefined" && eps !== null) {
        form.value.eps = Number(eps);
        value.value = Number(eps); // Sync slider
      }
      if (typeof algorithm !== "undefined" && algorithm !== null)
        form.value.algorithm = String(algorithm);
      if (typeof dbscan_eps !== "undefined" && dbscan_eps !== null)
        dbscanEps.value = Number(dbscan_eps);
      if (typeof dbscan_minPts !== "undefined" && dbscan_minPts !== null)
        dbscanMinPts.value = Number(dbscan_minPts);
    } catch (e) {}
  }
);

// watch the form and persist changes (debounced)
watch(
  form,
  () => {
    // if no project, don't attempt to persist
    if (!project || !project.currentProjectId) return;
    // debounce writes to avoid excessive socket calls
    if (saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      persistToProject();
    }, 500);
  },
  { deep: true }
);

const components = {
  ElForm,
  ElFormItem,
  ElInputNumber,
  ElSlider,
  ElSelect,
  ElOption,
  ElButton,
  ElCollapse,
  ElCollapseItem,
  ElIcon,
  InfoFilled,
};

function resetDefaults() {
  form.value.eps = 0.5;
  form.value.method = "components";
}

function applySuggested() {
  if (!diagnostics.value || !diagnostics.value.suggestedThreshold) return;
  form.value.eps = Number(diagnostics.value.suggestedThreshold);
  // persist immediately
  persistToProject();
}

function startClustering() {
  const projectId = project.currentProjectId || project.id || null;
  if (!projectId) {
    console.error("Project not selected");
    return;
  }

  // persist clustering params to project and save
  try {
    if (!project.data) project.data = {};
    project.data.clustering_eps = Number(form.value.eps);
    project.data.clustering_method = String("components");
    project.updateProject();
  } catch (e) {
    console.warn("Failed to persist clustering params to project", e);
  }

  const algorithm = String(form.value.algorithm || "components");
  const eps = Number(form.value.eps);
  const minPts = Number(dbscanMinPts.value);
  ipcClient
    .startClustering(Number(projectId), algorithm, algorithm === 'components' ? eps : Number(dbscanEps.value), algorithm === 'dbscan' ? minPts : undefined)
    .then(() => {
      // optionally show feedback
    })
    .catch((e) => console.error("Failed to start clustering via IPC", e));
}
</script>

<style scoped>
.class-slider :deep(.el-slider__runway) {
  background-color: var(--el-slider-main-bg-color) !important;
}

/* Set filled portion (before value) to theme runway color as requested */
.class-slider :deep(.el-slider__bar) {
  background-color: var(--el-slider-runway-bg-color) !important;
}
</style>
