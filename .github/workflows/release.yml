name: ü™ü Build and Release QuantBot (Windows)

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write # –Ω—É–∂–Ω–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –≤ —Ä–µ–ª–∏–∑

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js (—Ç–∞–∫–æ–π –∂–µ, –∫–∞–∫ –≤ CI)
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: npm

      # 3Ô∏è‚É£ –ö–µ—à Electron Builder, —á—Ç–æ–±—ã —É—Å–∫–æ—Ä–∏—Ç—å —Å–±–æ—Ä–∫—É
      - name: üíæ Cache Electron builder
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-cache

      # 4Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –Ω–∞–¥—ë–∂–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º
      #    —Å —Ñ–ª–∞–≥–æ–º --include=optional --force
      #    —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –±–∏–Ω–∞—Ä–Ω—ã–µ –ø–∞–∫–µ—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä @rollup/rollup-win32-x64-msvc)
      - name: üì¶ Install dependencies (safe)
        run: |
          rd /s /q node_modules || exit 0
          del package-lock.json || exit 0
          npm install --include=optional --force

      # 5Ô∏è‚É£ –°–±–æ—Ä–∫–∞ portable-–≤–µ—Ä—Å–∏–∏ QuantBot
      - name: üèóÔ∏è Build portable Windows app
        run: npm run build:win:portable:cross -- --publish never

      # 6Ô∏è‚É£ –°–æ–±–∏—Ä–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã (.exe, .yml –∏ —Ç.–ø.) –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é –ø–∞–ø–∫—É
      - name: üß© Collect release artifacts
        run: |
          mkdir dist-upload
          copy release\**\*.exe dist-upload\ || exit 0
          copy release\**\*.yml dist-upload\ || exit 0
          copy release\**\*.blockmap dist-upload\ || exit 0

      # 7Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –≤ GitHub Release
      - name: üöÄ Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist-upload/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
