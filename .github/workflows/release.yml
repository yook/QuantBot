name: ü™ü Build and Release QuantBot (Windows)

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write # –Ω—É–∂–Ω–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –≤ —Ä–µ–ª–∏–∑

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js (—Ç–∞ –∂–µ –≤–µ—Ä—Å–∏—è, —á—Ç–æ –≤ dev)
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: npm

      # 3Ô∏è‚É£ –ö–µ—à Electron –∏ electron-builder –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏
      - name: üíæ Cache Electron builder
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-cache

      # 4Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –±–∞–≥–∞ npm/rollup
      - name: üì¶ Install dependencies (safe)
        run: |
          Write-Host "üßπ Cleaning node_modules and lock file..."
          Remove-Item -Recurse -Force node_modules -ErrorAction SilentlyContinue
          Remove-Item -Force package-lock.json -ErrorAction SilentlyContinue
          Write-Host "üì¶ Installing dependencies..."
          npm install --include=optional --force
        shell: pwsh

      # 5Ô∏è‚É£ –°–±–æ—Ä–∫–∞ portable-–≤–µ—Ä—Å–∏–∏ QuantBot
      - name: üèóÔ∏è Build portable Windows app
        run: npm run build:win:portable:cross -- --publish never

      # 6Ô∏è‚É£ –°–æ–±–∏—Ä–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã (.exe, .yml, .blockmap) –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
      - name: üß© Collect release artifacts
        run: |
          Write-Host "üìÅ Collecting artifacts..."
          New-Item -ItemType Directory -Force -Path dist-upload | Out-Null
          Copy-Item -Path "release/**/*.exe" -Destination "dist-upload" -Force -ErrorAction SilentlyContinue
          Copy-Item -Path "release/**/*.yml" -Destination "dist-upload" -Force -ErrorAction SilentlyContinue
          Copy-Item -Path "release/**/*.blockmap" -Destination "dist-upload" -Force -ErrorAction SilentlyContinue
        shell: pwsh

      # 7Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –≤ GitHub Release
      - name: üöÄ Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist-upload/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
