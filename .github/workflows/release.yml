name: ü™ü Build and Release QuantBot (Windows)

on:
  release:
    types: [published]

permissions:
  contents: write # –Ω—É–∂–Ω–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –≤ —Ä–µ–ª–∏–∑

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js (—Ç–∞ –∂–µ –≤–µ—Ä—Å–∏—è, —á—Ç–æ –≤ dev)
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      # 2.1Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏—é –∏–∑ Git-—Ç–µ–≥–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ package.json –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è)
      - name: üîñ Set version from Git tag
        run: |
          $tagName = "${{ github.ref_name }}"
          $version = $tagName.Substring(1) # –£–¥–∞–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å "v"
          Write-Host "Tag name: $tagName -> target version: $version"

          # –ß–∏—Ç–∞–µ–º —Ç–µ–∫—É—â–∏–π package.json –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏—é
          try {
            $pkg = Get-Content -Raw -Path package.json | ConvertFrom-Json
          } catch {
            Write-Error "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å package.json: $_"
            exit 1
          }

          if ($pkg.version -eq $version) {
            Write-Host "package.json already has version $version ‚Äî skipping npm version"
          } else {
            Write-Host "Updating package.json version to $version"
            npm version $version --no-git-tag-version
          }
        shell: pwsh

      # 3Ô∏è‚É£ –ö–µ—à–∏—Ä—É–µ–º node_modules, —á—Ç–æ–±—ã —É—Å–∫–æ—Ä–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: üß∞ Cache node_modules
        uses: actions/cache@v4
        id: node-cache
        with:
          path: |
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # 4Ô∏è‚É£ –ö–µ—à Electron –∏ Electron Builder (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –±–∏–Ω–∞—Ä–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
      - name: üíæ Cache Electron builder
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-cache

      # 5Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (—á–∏—Ç–∞—è lockfile –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏)
      - name: üì¶ Install dependencies (ci)
        if: steps.node-cache.outputs.cache-hit != 'true'
        run: |
          Write-Host "üì¶ Installing dependencies using npm ci..."
          npm ci --prefer-offline --no-audit --no-fund
        shell: pwsh

      # 5.1Ô∏è‚É£ –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –Ω–∞—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π –¥–ª—è Electron (–≤–∞–∂–Ω–æ –¥–ª—è better-sqlite3)
      - name: üîß Rebuild native modules for Electron (better-sqlite3)
        run: |
          Write-Host "üîÅ Rebuilding native modules for Electron (win x64)..."
          
          # Set alternative cache and mirror locations for Electron headers
          $env:ELECTRON_CACHE = "$env:RUNNER_TEMP\electron-cache"
          $env:ELECTRON_CUSTOM_DIR = "37.10.0"
          $env:ELECTRON_MIRROR = "https://github.com/electron/electron/releases/download/"
          
          # Create cache directory
          New-Item -ItemType Directory -Force -Path $env:ELECTRON_CACHE | Out-Null
          
          # Retry logic for electron-rebuild with different strategies
          $maxRetries = 3
          $attempt = 1
          
          while ($attempt -le $maxRetries) {
            try {
              Write-Host "Attempt $attempt/$maxRetries - Rebuilding native modules..."
              
              if ($attempt -eq 1) {
                # First attempt: standard rebuild
                npx electron-rebuild -f -w better-sqlite3 --verbose
              } elseif ($attempt -eq 2) {
                # Second attempt: with cache dir and verbose logging  
                npx electron-rebuild -f -w better-sqlite3 --cache-dir=$env:ELECTRON_CACHE --verbose
              } else {
                # Third attempt: force rebuild without cache
                npx electron-rebuild -f -w better-sqlite3 --force --verbose --cache-dir=$env:ELECTRON_CACHE
              }
              
              Write-Host "‚úÖ Native modules rebuilt successfully!"
              break
            }
            catch {
              Write-Host "‚ùå Attempt $attempt failed: $_"
              $attempt++
              
              if ($attempt -le $maxRetries) {
                Write-Host "‚è≥ Waiting 10 seconds before retry..."
                Start-Sleep -Seconds 10
              } else {
                Write-Host "‚ùå All rebuild attempts failed. Trying fallback approach..."
                
                # Fallback: try to install pre-built binaries or skip rebuild
                try {
                  Write-Host "üîÑ Attempting to use pre-built better-sqlite3..."
                  npm rebuild better-sqlite3 --verbose
                  Write-Host "‚úÖ Fallback rebuild succeeded!"
                } catch {
                  Write-Host "‚ö†Ô∏è Native rebuild failed, but continuing build (app may use bundled SQLite fallback)"
                }
              }
            }
          }
        shell: pwsh

      # Workaround: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—Ç–∏–≤–Ω–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Rollup –¥–ª—è Windows
      - name: Install Rollup native for Windows (workaround npm optional deps bug)
        run: |
          Write-Host "Installing @rollup/rollup-win32-x64-msvc to avoid optional deps issue"
          npm i @rollup/rollup-win32-x64-msvc --no-save
        shell: pwsh

      # 6Ô∏è‚É£ –°–±–æ—Ä–∫–∞ portable-–≤–µ—Ä—Å–∏–∏ QuantBot
      - name: üèóÔ∏è Build portable Windows app
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: "false"
        run: npm run build:win:portable:cross -- --publish never

      # 7Ô∏è‚É£ –°–æ–±–∏—Ä–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã (.exe, .yml, .blockmap) –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
      - name: üß© Collect release artifacts
        run: |
          Write-Host "üìÅ Collecting artifacts..."
          New-Item -ItemType Directory -Force -Path dist-upload | Out-Null
          Copy-Item -Path "release/**/*.exe" -Destination "dist-upload" -Force -ErrorAction SilentlyContinue
          Copy-Item -Path "release/**/*.yml" -Destination "dist-upload" -Force -ErrorAction SilentlyContinue
          Copy-Item -Path "release/**/*.blockmap" -Destination "dist-upload" -Force -ErrorAction SilentlyContinue
        shell: pwsh

      # 8Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –≤ GitHub Release
      - name: üöÄ Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist-upload/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
