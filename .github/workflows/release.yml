name: ü™ü Build and Release QuantBot (Windows)

on:
  release:
    types: [published]

permissions:
  contents: write # –Ω—É–∂–Ω–æ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –≤ —Ä–µ–ª–∏–∑

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      # 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js (—Ç–∞ –∂–µ –≤–µ—Ä—Å–∏—è, —á—Ç–æ –≤ dev)
      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      # 3Ô∏è‚É£ –ö–µ—à–∏—Ä—É–µ–º node_modules, —á—Ç–æ–±—ã —É—Å–∫–æ—Ä–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: üß∞ Cache node_modules
        uses: actions/cache@v4
        id: node-cache
        with:
          path: |
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # 4Ô∏è‚É£ –ö–µ—à Electron –∏ Electron Builder (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –±–∏–Ω–∞—Ä–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)
      - name: üíæ Cache Electron builder
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-cache

      # 5Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (—á–∏—Ç–∞—è lockfile –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏)
      - name: üì¶ Install dependencies (ci)
        if: steps.node-cache.outputs.cache-hit != 'true'
        run: |
          Write-Host "üì¶ Installing dependencies using npm ci..."
          npm ci --prefer-offline --no-audit --no-fund
        shell: pwsh

      # 5.1Ô∏è‚É£ Rebuild native modules for Electron (important for @vscode/sqlite3)
      - name: üîß Rebuild native modules for Electron (@vscode/sqlite3)
        run: |
          Write-Host "ÔøΩ Rebuilding native modules for Electron (win x64)..."
          npx electron-rebuild -f -w @vscode/sqlite3 --arch=x64 --electron-version=37.0.0
        shell: pwsh

      # 6Ô∏è‚É£ –°–±–æ—Ä–∫–∞ portable-–≤–µ—Ä—Å–∏–∏ QuantBot
      - name: üèóÔ∏è Build portable Windows app
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: 'false'
        run: npm run build:win:portable:cross -- --publish never

      # 7Ô∏è‚É£ –°–æ–±–∏—Ä–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã (.exe, .yml, .blockmap) –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
      - name: üß© Collect release artifacts
        run: |
          Write-Host "üìÅ Collecting artifacts..."
          New-Item -ItemType Directory -Force -Path dist-upload | Out-Null
          Copy-Item -Path "release/**/*.exe" -Destination "dist-upload" -Force -ErrorAction SilentlyContinue
          Copy-Item -Path "release/**/*.yml" -Destination "dist-upload" -Force -ErrorAction SilentlyContinue
          Copy-Item -Path "release/**/*.blockmap" -Destination "dist-upload" -Force -ErrorAction SilentlyContinue
        shell: pwsh

      # 8Ô∏è‚É£ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –≤ GitHub Release
      - name: üöÄ Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist-upload/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
